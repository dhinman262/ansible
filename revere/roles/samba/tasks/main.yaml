- include_vars: ../vars/main.yaml

# Create the home directory for smbguest, and set its mode

# Create the home directory for smbadmin, and set its mode

- name: Check if smbguest exists in /etc/passwd
  shell: "grep smbguest /etc/passwd"
  register: smbguest_user_exists
  failed_when: "smbguest_user_exists.rc == 2"
  check_mode: no

# Create the smbguest user
- name: "Create smbguest user"
  become: yes
  user:
    group: sambashare
    home: /home/share/smbguest
    name: smbguest
    password: "{{ SAMBA_PASSWORD_HASHED }}"
    shell: /usr/sbin/nologin
  when: smbguest_user_exists.rc == 1
# https://stackoverflow.com/questions/44762488/non-interactive-samba-user-creation-via-ansible

- name: "Set modes on smbguest home"
  become: yes
  file:
    path: /home/share/smbguest
    state: directory
    mode: '2770'
    
- name: "set samba password for smbguest"
  become: yes
  shell: "printf '{{smbguest\n{{ SAMBA_PASSWORD }}\n' | smbpasswd -a -e smbguest"

# Create the smbadmin user

# Put smbguest into the samba password file, and enable it

- name: Illustrate value of encrypted variable
  shell: |
    echo "The following line has the variable in in"
    echo " === {{ SAMBA_PASSWORD }} ==="

